{% extends "base.html" %}

{% block title %}Chat - {{ group.name }}{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Sessions Sidebar -->
    <div class="col-md-3 mb-4">
        <div class="sidebar">
            <div class="p-3 border-bottom">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>Sessions
                </h6>
                <a href="{{ url_for('chat_interface', group_id=group._id) }}" class="btn btn-outline-primary btn-sm mt-2 w-100">
                    <i class="fas fa-plus me-1"></i>New Chat
                </a>
            </div>
            <div class="p-2">
                {% if all_sessions %}
                    {% for session in all_sessions %}
                        <div class="session-item p-2 mb-1 {% if session.session_id == current_session_id %}active{% endif %}"
                             onclick="location.href='{{ url_for('chat_interface', group_id=group._id, session_id=session.session_id) }}'">
                            <div class="fw-semibold small">{{ session.title[:30] }}{% if session.title|length > 30 %}...{% endif %}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                {{ session.message_count }} messages â€¢ {{ session.last_message_at | datetime }}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-comment mb-2"></i>
                        <div class="small">No sessions yet</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-9">
        <div class="card h-100 d-flex flex-column">
            <!-- Chat Header -->
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            {% if group.name == 'General Chat' %}
                                <i class="fas fa-comments text-success me-2"></i>
                            {% else %}
                                <i class="fas fa-folder text-primary me-2"></i>
                            {% endif %}
                            {{ group.name }}
                        </h5>
                        {% if session_data %}
                            <small class="text-muted">{{ session_data.title }}</small>
                        {% else %}
                            <small class="text-muted">New conversation</small>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('group_detail', group_id=group._id) }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-cog me-1"></i>Manage
                    </a>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="card-body flex-grow-1 d-flex flex-column">
                <div id="messagesContainer" class="flex-grow-1 overflow-auto mb-3" style="max-height: 60vh;">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="chat-message {{ 'user-message' if message.message_type == 'user' else 'assistant-message' }}">
                                <div class="card">
                                    <div class="card-body p-3">
                                        {% if message.message_type == 'user' %}
                                            <div class="d-flex align-items-start">
                                                <div class="flex-grow-1">
                                                    {{ message.content }}
                                                </div>
                                                <i class="fas fa-user ms-2"></i>
                                            </div>
                                        {% else %}
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-robot text-primary me-2"></i>
                                                <div class="flex-grow-1">
                                                    {{ message.content }}
                                                    {% if message.context_used %}
                                                        <div class="mt-2">
                                                            <small class="text-muted">
                                                                <i class="fas fa-book me-1"></i>
                                                                Referenced {{ message.context_used|length }} document(s)
                                                            </small>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div class="text-end mt-2">
                                            <small class="text-muted">{{ message.created_at | datetime }}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comment-dots" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">Start a conversation</h5>
                            <p>{% if group.name == 'General Chat' %}Ask me anything! I'll help based on my general knowledge.{% else %}Ask questions about your uploaded documents or anything else.{% endif %}</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center py-3" style="display: none;">
                    <div class="spinner-grow text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="text-muted mt-2">AI is thinking...</div>
                </div>

                <!-- Chat Input -->
                <form id="chatForm" class="d-flex gap-2">
                    <input type="text" id="messageInput" class="form-control chat-input" 
                           placeholder="Type your message..." required>
                    <button type="submit" class="btn btn-primary" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const messagesContainer = document.getElementById('messagesContainer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const sendButton = document.getElementById('sendButton');

    // Auto-scroll to bottom
    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Add message to chat
    function addMessage(content, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${isUser ? 'user-message' : 'assistant-message'}`;
        
        const timestamp = new Date().toLocaleString();
        
        messageDiv.innerHTML = `
            <div class="card">
                <div class="card-body p-3">
                    ${isUser ? 
                        `<div class="d-flex align-items-start">
                            <div class="flex-grow-1">${content}</div>
                            <i class="fas fa-user ms-2"></i>
                        </div>` :
                        `<div class="d-flex align-items-start">
                            <i class="fas fa-robot text-primary me-2"></i>
                            <div class="flex-grow-1">${content}</div>
                        </div>`
                    }
                    <div class="text-end mt-2">
                        <small class="text-muted">${timestamp}</small>
                    </div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;

        // Disable input and show loading
        messageInput.disabled = true;
        sendButton.disabled = true;
        loadingIndicator.style.display = 'block';

        // Add user message
        addMessage(message, true);
        messageInput.value = '';

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    group_id: '{{ group._id }}',
                    {% if current_session_id %}
                    session_id: '{{ current_session_id }}'
                    {% endif %}
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Add assistant response
                addMessage(data.response);
                
                // If this is a new session, redirect to include session_id
                if (!{{ 'true' if current_session_id else 'false' }} && data.session_id) {
                    window.location.href = `{{ url_for('chat_interface', group_id=group._id) }}/${data.session_id}`;
                }
            } else {
                addMessage(`Sorry, there was an error: ${data.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            addMessage('Sorry, there was a connection error. Please try again.');
        } finally {
            // Re-enable input and hide loading
            messageInput.disabled = false;
            sendButton.disabled = false;
            loadingIndicator.style.display = 'none';
            messageInput.focus();
        }
    });

    // Focus on input
    messageInput.focus();
    
    // Scroll to bottom on load
    scrollToBottom();

    // Handle Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}